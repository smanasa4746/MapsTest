<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mauze Directory</title>

    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Poppins,Arial,sans-serif;
            background: linear-gradient(135deg,#dce8ff,#f4f8ff);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding-top: 40px;
        }

        .container {
            width: 740px
        }

        h2 {
            font-size: 32px;
            font-weight: 700;
            text-align: center;
            background: linear-gradient(90deg,#0a58ff,#4ca1ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
        }

        .select-area {
            background: rgba(255,255,255,.6);
            border-radius: 18px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,.15);
            margin-bottom: 25px;
        }

        .card {
            border-radius: 18px;
            padding: 22px;
            background: rgba(255,255,255,.95);
            box-shadow: 0 10px 30px rgba(0,0,0,.2);
        }

        .row {
            margin: 10px 0;
            font-size: 18px;
            color: #19324a
        }

            .row b {
                color: #0a3d91
            }

        .btnMap {
            display: inline-block;
            margin-top: 10px;
            padding: 10px 18px;
            background: linear-gradient(90deg,#0072ff,#00c6ff);
            color: #fff;
            border-radius: 10px;
            text-decoration: none;
            font-weight: 600;
        }

        .infoBox {
            margin-top: 8px;
            padding: 10px;
            background: #f1f6ff;
            border-radius: 10px;
        }

        .notice {
            margin-top: 10px;
            padding: 10px;
            background: #fff3cd;
            border-radius: 8px;
            color: #856404;
            font-weight: 600;
        }

        iframe {
            border-radius: 12px
        }
    </style>
</head>

<body>
    <div class="container">

        <h2>Mauze Directory</h2>

        <div class="select-area">
            <select id="mauzeDropdown" style="width:100%;">
                <option value="">Search Mauze‚Ä¶</option>
            </select>
        </div>

        <div id="resultContainer" style="display:none;">
            <div class="card">

                <div class="row"><b>Mauze ID:</b> <span id="mauzeID"></span></div>
                <div class="row"><b>Mauze Name:</b> <span id="mauzeName"></span></div>
                <div class="row"><b>Ilaqa:</b> <span id="ilaqa"></span></div>
                <div class="row"><b>Jamiat:</b> <span id="jamiat"></span></div>

                <div class="row"><b>üìç Mauze Location:</b></div>
                <div id="mapContainer"></div>

                <div class="row">
                    <b>üìè Distance from your location:</b>
                    <span id="userDistance">Detecting‚Ä¶</span>
                </div>

                <div class="row"><b>üöÜ Nearest Railway Station:</b></div>
                <div id="railwayInfo" class="infoBox"></div>

                <div class="row"><b>‚úàÔ∏è Nearest Airport:</b></div>
                <div id="airportInfo" class="infoBox"></div>

            </div>
        </div>

    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        const csvUrl =
            "https://docs.google.com/spreadsheets/d/e/2PACX-1vRapA0pNoeBH0W6n_HYVB2ieB_2ZEi8SPp5ZRAM_oMWLJDn0FVsl6317AEbX1tDZOjyO_WRzW_HWRQb/pub?gid=0&single=true&output=csv";

        const GOOGLE_API_KEY = "AIzaSyAkSyCN2lCcEwtrzY-G0FeCsSsr19xd-9E";

        let sheetData = [];

        /* ---------- helpers ---------- */
        function normalizeHeader(h) {
            return h.toString().replace(/\r|\n/g, "").trim().toLowerCase();
        }
        function haversine(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a =
                Math.sin(dLat / 2) ** 2 +
                Math.cos(lat1 * Math.PI / 180) *
                Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) ** 2;
            return (R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a))).toFixed(2);
        }
        function getUserLocation(cb) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    p => cb(p.coords.latitude, p.coords.longitude),
                    () => cb(null, null)
                );
            } else cb(null, null);
        }

        /* ---------- load sheet ---------- */
        Papa.parse(csvUrl, {
            download: true,
            header: true,
            skipEmptyLines: true,
            transformHeader: normalizeHeader,
            complete: function (res) {
                sheetData = res.data;

                sheetData.sort((a, b) =>
                    (a["jamiat"] || "").localeCompare(b["jamiat"] || "") ||
                    (a["mauze name"] || "").localeCompare(b["mauze name"] || "")
                );

                sheetData.forEach(r => {
                    if (r["mauze id"] && r["mauze name"]) {
                        $("#mauzeDropdown").append(
                            new Option(`${r["jamiat"]} - ${r["mauze name"]}`, r["mauze id"])
                        );
                    }
                });

                $("#mauzeDropdown").select2({
                    placeholder: "Search Jamiat / Mauze Name",
                    allowClear: true
                });
            }
        });

        /* ---------- on select ---------- */
        $("#mauzeDropdown").on("change", function () {
            const row = sheetData.find(r => r["mauze id"] == this.value);
            if (!row) return;

            $("#resultContainer").show();
            $("#mauzeID").text(row["mauze id"]);
            $("#mauzeName").text(row["mauze name"]);
            $("#ilaqa").text(row["ilaqa"]);
            $("#jamiat").text(row["jamiat"]);

            const [lat, lng] = row["coordinates"]
                .replace(/[^\d.,\-]/g, "")
                .split(",")
                .map(Number);

            /* Mauze pin */
            $("#mapContainer").html(`
            <iframe width="100%" height="300" loading="lazy"
                src="https://www.google.com/maps/embed/v1/place?key=${GOOGLE_API_KEY}&q=${lat},${lng}&zoom=15">
            </iframe>
            <a class="btnMap" target="_blank"
               href="https://www.google.com/maps?q=${lat},${lng}">
               Open Mauze Location
            </a>
        `);

            /* USER ‚Üí MAUZE DISTANCE */
            $("#userDistance").text("Detecting‚Ä¶");
            getUserLocation((uLat, uLng) => {
                if (uLat && uLng) {
                    $("#userDistance").text(haversine(uLat, uLng, lat, lng) + " km");
                } else {
                    $("#userDistance").text("Location permission denied");
                }
            });

            /* üöÜ Railway ‚Äî wider zoom, Mauze-based */
            $("#railwayInfo").html(`
            <iframe width="100%" height="220" loading="lazy"
                src="https://www.google.com/maps/embed/v1/search?key=${GOOGLE_API_KEY}&q=railway+station&center=${lat},${lng}&zoom=10">
            </iframe>
            <a class="btnMap" target="_blank"
               href="https://www.google.com/maps/search/railway+station/@${lat},${lng},10z">
               Open Railway Stations
            </a>
        `);

            /* ‚úàÔ∏è Airport ‚Äî wider zoom, Mauze-based */
            $("#airportInfo").html(`
            <iframe width="100%" height="220" loading="lazy"
                src="https://www.google.com/maps/embed/v1/search?key=${GOOGLE_API_KEY}&q=airport&center=${lat},${lng}&zoom=9">
            </iframe>
            <a class="btnMap" target="_blank"
               href="https://www.google.com/maps/search/airport/@${lat},${lng},9z">
               Open Airports
            </a>
        `);
        });
    </script>

</body>
</html>
